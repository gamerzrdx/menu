#!/bin/bash
set -e

clear
echo -e "\e[1;36m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\e[0m"
echo -e " 🪽 Pterodactyl Wings Installer - Starting Setup..."
echo -e "\e[1;36m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\e[0m"
echo ""

# ------------------------
# 1. Docker install
# ------------------------
echo -e "🐳 Installing Docker (stable release)..."
curl -sSL https://get.docker.com/ | CHANNEL=stable bash
sudo systemctl enable --now docker

# ------------------------
# 2. Update GRUB
# ------------------------
GRUB_FILE="/etc/default/grub"
if [ -f "$GRUB_FILE" ]; then
    echo -e "⚙️  Updating GRUB configuration for swap accounting..."
    sudo sed -i 's/^GRUB_CMDLINE_LINUX_DEFAULT=.*/GRUB_CMDLINE_LINUX_DEFAULT="swapaccount=1"/' $GRUB_FILE
    sudo update-grub
fi

# ------------------------
# 3. Wings install
# ------------------------
echo -e "🪽 Downloading latest Wings binary..."
sudo mkdir -p /etc/pterodactyl
ARCH=$(uname -m)
if [ "$ARCH" == "x86_64" ]; then ARCH="amd64"; else ARCH="arm64"; fi
curl -L -o /usr/local/bin/wings "https://github.com/pterodactyl/wings/releases/latest/download/wings_linux_$ARCH"
sudo chmod u+x /usr/local/bin/wings

# ------------------------
# 4. Wings service
# ------------------------
echo -e "🔧 Creating systemd service for Wings..."
WINGS_SERVICE_FILE="/etc/systemd/system/wings.service"
sudo tee $WINGS_SERVICE_FILE > /dev/null <<EOF
[Unit]
Description=Pterodactyl Wings Daemon
After=docker.service
Requires=docker.service
PartOf=docker.service

[Service]
User=root
WorkingDirectory=/etc/pterodactyl
LimitNOFILE=4096
PIDFile=/var/run/wings/daemon.pid
ExecStart=/usr/local/bin/wings
Restart=on-failure
StartLimitInterval=180
StartLimitBurst=30
RestartSec=5s

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable wings

# ------------------------
# 5. SSL Certificate
# ------------------------
echo -e "🔐 Generating self-signed SSL certificate..."
sudo mkdir -p /etc/certs/wing
cd /etc/certs/wing || exit
sudo openssl req -new -newkey rsa:4096 -days 3650 -nodes -x509 \
-subj "/C=NA/ST=NA/L=NA/O=NA/CN=Generic SSL Certificate" \
-keyout privkey.pem -out fullchain.pem

# ------------------------
# 6. Helper command
# ------------------------
echo -e "🛠 Adding quick 'wing' helper command..."
sudo tee /usr/local/bin/wing > /dev/null <<'EOF'
#!/bin/bash
echo "👉 To start Wings manually, run:"
echo "    sudo systemctl start wings"
echo "⚠️  Reminder: Make sure Node port 8080 → 443 is mapped."
EOF
sudo chmod +x /usr/local/bin/wing

echo ""
echo -e "\e[1;32m✅ Wings base setup complete!\e[0m"
echo -e "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo -e "   Use: \e[1;37msudo systemctl start wings\e[0m to run Wings"
echo -e "   Or:  \e[1;37mwing\e[0m for a quick reminder"
echo -e "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# ------------------------
# 7. Optional Auto-configure Wings
# ------------------------
read -p "⚡ Do you want to auto-configure Wings now? (y/n): " AUTO_CONFIG

if [[ "$AUTO_CONFIG" =~ ^[Yy]$ ]]; then
    echo -e "\n🔧 Auto-configuring Wings..."
    read -p "   ➡️ Enter UUID: " UUID
    read -p "   ➡️ Enter Token ID: " TOKEN_ID
    read -p "   ➡️ Enter Token: " TOKEN
    read -p "   ➡️ Enter Panel URL (remote): " REMOTE

    mkdir -p /etc/pterodactyl
    tee /etc/pterodactyl/config.yml > /dev/null <<CFG
debug: false
uuid: ${UUID}
token_id: ${TOKEN_ID}
token: ${TOKEN}
api:
  host: 0.0.0.0
  port: 8080
  ssl:
    enabled: true
    cert: /etc/certs/wing/fullchain.pem
    key: /etc/certs/wing/privkey.pem
  upload_limit: 100
system:
  data: /var/lib/pterodactyl/volumes
  sftp:
    bind_port: 2022
allowed_mounts: []
remote: '${REMOTE}'
CFG

    echo -e "📂 Config saved to \e[1;37m/etc/pterodactyl/config.yml\e[0m"
    echo -e "🚀 Starting Wings service..."
    systemctl start wings
    echo -e "✅ Wings is now running!"
else
    echo -e "⏭️  Skipping auto-configuration."
    echo -e "👉 Start manually with: \e[1;37msudo systemctl start wings\e[0m"
fi
