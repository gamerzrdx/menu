#!/bin/bash
set -e

# ================================
#   Cloudflared Installer Script
# ================================

# --- Colors ---
GREEN="\033[1;32m"
RED="\033[1;31m"
CYAN="\033[1;36m"
YELLOW="\033[1;33m"
NC="\033[0m" # Reset

# --- Banner ---
clear
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "   🌐 ${YELLOW}CLOUDFLARED INSTALLER UTILITY${NC} 🌐"
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

echo -e "${GREEN}[*] Starting Cloudflared installation...${NC}"

# Step 1: Create keyrings directory
echo -e "${GREEN}[+] Creating keyrings directory...${NC}"
sudo mkdir -p --mode=0755 /usr/share/keyrings

# Step 2: Add Cloudflare GPG key
echo -e "${GREEN}[+] Adding Cloudflare GPG key...${NC}"
curl -fsSL https://pkg.cloudflare.com/cloudflare-main.gpg \
  | sudo tee /usr/share/keyrings/cloudflare-main.gpg >/dev/null

# Step 3: Add repository to apt sources
echo -e "${GREEN}[+] Adding Cloudflare repository...${NC}"
echo 'deb [signed-by=/usr/share/keyrings/cloudflare-main.gpg] https://pkg.cloudflare.com/cloudflared any main' \
  | sudo tee /etc/apt/sources.list.d/cloudflared.list >/dev/null

# Step 4: Update package list and install cloudflared
echo -e "${GREEN}[+] Updating package list and installing cloudflared...${NC}"
sudo apt-get update && sudo apt-get install -y cloudflared

# Step 5: Verify installation
if command -v cloudflared >/dev/null 2>&1; then
    echo -e "${GREEN}[✓] Cloudflared installed successfully!${NC}"
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e " 🎉 ${YELLOW}Installation complete!${NC} Run 'cloudflared --help' to get started."
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
else
    echo -e "${RED}[✗] Installation failed.${NC}"
    exit 1
fi
